---
# Check K3S cluster health
# Usage: ansible-playbook playbooks/health-check.yaml

- name: K3S Cluster Health Check
  hosts: k3s_cluster
  become: true

  tasks:
    - name: Check K3S service status
      systemd:
        name: k3s
      register: k3s_service
      failed_when: false

    - name: Check K3S agent service status (workers)
      systemd:
        name: k3s-agent
      register: k3s_agent_service
      failed_when: false
      when: "'workers' in group_names"

    - name: Get K3S version
      command: k3s --version
      register: k3s_version
      changed_when: false
      failed_when: false

    - name: Check disk space
      shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage
      changed_when: false

    - name: Check memory usage
      shell: free -m | awk 'NR==2{printf "%.0f", $3*100/$2}'
      register: memory_usage
      changed_when: false

    - name: Check system load
      shell: cat /proc/loadavg | awk '{print $1}'
      register: system_load
      changed_when: false

    - name: Display node health
      debug:
        msg: |
          === {{ inventory_hostname }} ({{ ansible_host }}) ===
          K3S Version: {{ k3s_version.stdout_lines[0] | default('N/A') }}
          Service: {{ 'Running' if (k3s_service.status.ActiveState | default('unknown')) == 'active' or (k3s_agent_service.status.ActiveState | default('unknown')) == 'active' else 'Not Running' }}
          Disk Usage: {{ disk_usage.stdout }}%
          Memory Usage: {{ memory_usage.stdout }}%
          System Load: {{ system_load.stdout }}

- name: Check cluster status from control plane
  hosts: control_plane[0]
  become: true

  tasks:
    - name: Get node status
      command: k3s kubectl get nodes -o wide
      register: nodes_status
      changed_when: false

    - name: Get pod status
      command: k3s kubectl get pods --all-namespaces -o wide
      register: pods_status
      changed_when: false

    - name: Display cluster status
      debug:
        msg: |
          === CLUSTER NODE STATUS ===
          {{ nodes_status.stdout }}
          
          === POD STATUS ===
          {{ pods_status.stdout }}
