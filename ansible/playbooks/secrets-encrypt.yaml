---
# Enable K3S secrets encryption at rest
# Usage: ansible-playbook playbooks/secrets-encrypt.yaml

- name: Enable K3S Secrets Encryption
  hosts: control_plane[0]
  become: true

  tasks:
    - name: Check current encryption status
      command: k3s secrets-encrypt status
      register: encrypt_status_before
      changed_when: false
      failed_when: false

    - name: Display current status
      debug:
        msg: "{{ encrypt_status_before.stdout_lines }}"

    - name: Enable secrets encryption
      command: k3s secrets-encrypt enable
      when: "'Disabled' in encrypt_status_before.stdout"
      register: enable_result

    - name: Wait for encryption to propagate
      pause:
        seconds: 10
      when: enable_result.changed | default(false)

    - name: Re-encrypt existing secrets
      command: k3s secrets-encrypt reencrypt
      when: enable_result.changed | default(false)

- name: Verify encryption on all control plane nodes
  hosts: control_plane
  become: true

  tasks:
    - name: Check encryption status
      command: k3s secrets-encrypt status
      register: encrypt_status
      changed_when: false

    - name: Display encryption status
      debug:
        msg: |
          === {{ inventory_hostname }} ===
          {{ encrypt_status.stdout }}
